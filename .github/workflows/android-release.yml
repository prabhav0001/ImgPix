name: Android Release Build

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build:
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Set up JDK 21
              uses: actions/setup-java@v5
              with:
                  java-version: "21"
                  distribution: "temurin"

            - name: Setup Gradle
              uses: gradle/actions/setup-gradle@v5

            - name: Generate Debug Keystore
              run: |
                  mkdir -p ~/.android/
                  keytool -genkey -v -keystore ~/.android/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"

            - name: Grant execute permission for gradlew
              run: chmod +x gradlew

            - name: Build Release APK
              run: ./gradlew assembleRelease

            - name: Upload Release APK
              uses: actions/upload-artifact@v5
              with:
                  name: app-release
                  path: app/build/outputs/apk/release/app-release.apk
                  retention-days: 7
